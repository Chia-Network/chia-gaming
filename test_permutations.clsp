(include *standard-cl-23*)
(import std.prepend)
(import std.reverse)
(import std.map)
(import std.len)
(import std.range)
(import std.sort)
(import std.assert)
(import std.deep_compare)
(import std.permutations)
(import std.last)
(import std.busy)
(import std.all_in_list)
(import std.print)

(export (M N)
    (assert
        ;; Is permutations expected to collapse equal alternatives when two of
        ;; the items to shuffle are equal?
        (= (* (! M) 4) (len (permutations (c 0 (range M)))))
        (busy
            (lambda (listlen)
                (assign 
                    mylist (range listlen)
                    permed (permutations mylist)
                    (assert
                        (= (len permed) (! listlen))
                        ;; ensure we didn't produce any permutations that have
                        ;; repeated elements in them, which would indicate that
                        ;; the permutation function misbehaved
                        (all-in-list (map (lambda (L) (no_repeats L)) permed))
                        (no_repeats permed)
                    )
                )
            )
            (reverse (range N))
            1
        )
        (deep= (permutations 0) (q ()))
        0
    )
)

(defun ! (x)
    (if x
        (* x (! (- x 1)))
        1
    )
)

(defun no_repeats_inner ((first . remainder))
    (if remainder
        (if (deep= first (f remainder))
            0
            (no_repeats_inner remainder)
        )
        1
    )
)

(defun no_repeats (mylist)
    (if mylist
        (no_repeats_inner (sort (lambda (a b) (= (deep_compare a b) -1)) mylist))
        1
    )
)

